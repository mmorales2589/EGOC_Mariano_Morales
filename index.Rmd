---
title: "Tablero - Planificacion y Costos"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
```

# ESTADO GENERAL DEL PROYECTO

## Column {data-width="400"}

### Informacion General

-   Obra
-   Ubicacion
-   Superficie
-   Duracion
-   Presupuesto

------------------------------------------------------------------------

```{r}

# Asegúrate de tener la librería 'gt' instalada: install.packages("gt")
library(gt)
library(dplyr)

# 1. Definir el monto
monto_total <- 33929840323.37

# 2. Crear un dataframe para la tabla
datos_etiqueta <- data.frame(
  Etiqueta = "MONTO TOTAL DEL PROYECTO",
  Monto = monto_total
)

# 3. Crear la tabla GT (la etiqueta gráfica)
etiqueta_grafica <- datos_etiqueta %>%
  gt() %>%
  # Formatear la columna del monto como moneda
  fmt_currency(
    columns = Monto,
    currency = "USD", # Símbolo de dólar
    sep_mark = ".",   # Separador de miles (punto)
    dec_mark = ",",   # Separador de decimales (coma)
    decimals = 0      # Cero decimales para mayor limpieza
  ) %>%
  # Aplicar un estilo destacado a la celda del monto
  tab_style(
    style = cell_fill(color = "#E0FFE0"), # Fondo verde muy claro
    locations = cells_body(columns = Monto)
  ) %>%
  tab_style(
    style = cell_text(weight = "bold", size = px(30), color = "#00AA00"), # Fuente grande y verde
    locations = cells_body(columns = Monto)
  ) %>%
  # Personalizar el encabezado (la etiqueta)
  tab_header(
    title = md("**MONTO TOTAL DEL PROYECTO**")
  ) %>%
  # Ocultar la columna de 'Etiqueta' (ya está en el título) y el encabezado de la columna 'Monto'
  cols_hide(columns = Etiqueta) %>%
  cols_label(Monto = "") %>%
  # Eliminar líneas de borde y elementos innecesarios
  tab_options(
    table.border.top.color = "#00AA00",
    table.border.top.width = px(3),
    table.border.bottom.width = px(0),
    column_labels.hidden = TRUE
  )

# 4. Mostrar la etiqueta gráfica
etiqueta_grafica

```

------------------------------------------------------------------------

```{r}

# Asegúrate de tener la librería 'gt' instalada: install.packages("gt")
library(gt)
library(dplyr)

# 1. Definir el plazo
plazo_total <- 48

# 2. Crear un dataframe para la tabla
datos_etiqueta_plazo <- data.frame(
  Etiqueta = "PLAZO TOTAL DE LA OBRA (MESES)",
  Plazo = plazo_total
)

# 3. Crear la tabla GT (la etiqueta gráfica)
etiqueta_grafica_plazo <- datos_etiqueta_plazo %>%
  gt() %>%
  # Formatear la columna del plazo (añadiendo el texto "meses")
  fmt_integer(
    columns = Plazo
  ) %>%
  text_transform(
    locations = cells_body(columns = Plazo),
    fn = function(x) {
      paste(x, "MESES")
    }
  ) %>%
  # Aplicar un estilo destacado a la celda del plazo
  tab_style(
    style = cell_fill(color = "#E0F2FF"), # Fondo azul muy claro
    locations = cells_body(columns = Plazo)
  ) %>%
  tab_style(
    style = cell_text(weight = "bold", size = px(30), color = "#007BFF"), # Fuente grande y azul
    locations = cells_body(columns = Plazo)
  ) %>%
  # Personalizar el encabezado (la etiqueta)
  tab_header(
    title = md("**PLAZO TOTAL DE LA OBRA**")
  ) %>%
  # Ocultar la columna de 'Etiqueta' y el encabezado de la columna 'Plazo'
  cols_hide(columns = Etiqueta) %>%
  cols_label(Plazo = "") %>%
  # Eliminar líneas de borde y elementos innecesarios
  tab_options(
    table.border.top.color = "#007BFF",
    table.border.top.width = px(3),
    table.border.bottom.width = px(0),
    column_labels.hidden = TRUE
  )

# 4. Mostrar la etiqueta gráfica
etiqueta_grafica_plazo

```

## Column {data-width="600"}

### Distribucion de costos

```{r}

# Asegúrate de tener estas librerías instaladas:
# install.packages(c("dplyr", "plotly"))

library(dplyr)
library(plotly)

# 1. Crear el data frame (usando los datos proporcionados)
datos_costos <- data.frame(
  Etapa = c("FUNDACIONES", "ESTRUCTURA", "ALBAÑILERIA", "TERMINACIONES", "INSTALACIONES", "CARPINTERIAS"),
  Costo = c(2677715484.15, 6799536906.11, 6804389313.68, 3921319730.90, 6066123457.62, 7660755430.91)
)

# 2. Crear el gráfico interactivo de dona con plotly
grafico_plotly <- plot_ly(datos_costos, 
                          labels = ~Etapa, 
                          values = ~Costo, 
                          type = 'pie', 
                          # Configuración para el formato de dona
                          hole = 0.6,
                          # Personalización del texto en el tooltip
                          textinfo = 'label+percent',
                          # Personalización del tooltip (lo que se muestra al pasar el ratón)
                          hovertemplate = "<b>Etapa:</b> %{label}<br><b>Costo:</b> $%{value:, .2f}<br><b>Porcentaje:</b> %{percent}<extra></extra>") %>%
  
  layout(title = 'Distribucion de los costos directos',
         # Posiciona el título en el centro de la dona
         annotations = list(text = 'Costos', x = 0.5, y = 0.5, font = list(size = 18), showarrow = FALSE),
         showlegend = TRUE)

# 3. Mostrar el gráfico
grafico_plotly

```

### Cronograma

```{r}

# Cargar librerías
library(tidyverse)
library(scales) # Para formatear las etiquetas

# 1. Definir los datos de las tareas
gantt_data <- data.frame(
  Etapa = factor(c("FUNDACIONES", "ESTRUCTURA", "ALBAÑILERIA", "TERMINACIONES", "INSTALACIONES", "CARPINTERIAS"),
                 levels = rev(c("FUNDACIONES", "ESTRUCTURA", "ALBAÑILERIA", "TERMINACIONES", "INSTALACIONES", "CARPINTERIAS"))), # Revierte el orden para que el gráfico quede de arriba a abajo
  Start = c(1, 9, 17, 25, 33, 41), # Mes de inicio
  End = c(8, 16, 24, 32, 40, 48),   # Mes de fin (Duración de 8 meses)
  Duracion = 8
)

# 2. Crear el diagrama de Gantt con ggplot2
gantt_chart <- ggplot(gantt_data, aes(y = Etapa)) +
  
  # 2.1 Barras principales (la duración de la tarea)
  geom_segment(aes(x = Start, xend = End, yend = Etapa, color = Etapa), 
               size = 15, # Grosor de la barra
               show.legend = FALSE) +
  
  # 2.2 Etiquetas de duración (opcional: muestra la duración de 8 meses)
  geom_text(aes(x = (Start + End) / 2, label = paste0(Duracion, " meses")), 
            color = "white", size = 3) +
  
  # 2.3 Personalización de la escala y ejes
  scale_x_continuous(breaks = seq(0, 48, by = 4), # Marcas cada 4 meses
                     limits = c(0, 48), 
                     expand = c(0, 0)) +
  
  # 2.4 Títulos y temas
  labs(
    title = "Planificacion de obra",
    x = "Tiempo (Meses)",
    y = ""
  ) +
  
  # 2.5 Mejoras estéticas
  theme_bw() + # Tema blanco y negro
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    panel.grid.major.y = element_blank(), # Elimina líneas horizontales gruesas
    panel.grid.minor.x = element_blank(), # Elimina líneas verticales delgadas
    panel.grid.major.x = element_line(linetype = "dashed", color = "gray80") # Líneas de tiempo punteadas
  )

# 3. Mostrar el gráfico
gantt_chart

```

# PLANIFICACION

### Datos

-   Avance Planificado
-   Avance Real
-   Avance Temporal

----------------

### Grafico

```{r}

## Bloque de código R para el gráfico de avance mensual

# Cargar librerías necesarias
# install.packages(c("tidyverse", "scales"))
library(tidyverse)
library(ggplot2)
library(scales) 

# --- PARÁMETROS ---
DURACION_MESES <- 48
TOTAL_PROGRESO <- 100

# 1. GENERACIÓN DEL AVANCE PLANIFICADO (Constante)
# Avance mensual constante: 100 / 48
avance_planificado <- rep(TOTAL_PROGRESO / DURACION_MESES, DURACION_MESES)

# 2. GENERACIÓN Y ESCALADO DEL AVANCE REAL (Variable)
set.seed(42) # Fija la semilla para reproducibilidad de los números aleatorios
# Generar 48 valores aleatorios entre 1.5 y 2.5
avance_real_raw <- runif(DURACION_MESES, min = 1.5, max = 2.5)

# Ajustar los valores para que su suma total sea EXACTAMENTE 100%
factor_ajuste <- TOTAL_PROGRESO / sum(avance_real_raw)
avance_real <- avance_real_raw * factor_ajuste

# Comprobación (opcional): sum(avance_real) debe ser 100
# print(sum(avance_real)) 

# 3. CONSOLIDACIÓN DE DATOS
df_avance <- data.frame(
  Mes = 1:DURACION_MESES,
  Planificado = avance_planificado,
  Real = avance_real
)

# 4. TRANSFORMAR A FORMATO LARGO (Necesario para ggplot con barras agrupadas)
df_long <- df_avance %>%
  pivot_longer(
    cols = c(Planificado, Real),
    names_to = "Tipo_Avance",
    values_to = "Porcentaje"
  )

# 5. GENERACIÓN DEL GRÁFICO DE BARRAS
avance_plot <- ggplot(df_long, aes(x = factor(Mes), y = Porcentaje, fill = Tipo_Avance)) +
  
  # Usar geom_col (barras) con position = "dodge" para ponerlas lado a lado
  geom_col(position = "dodge") +
  
  # Colores y etiquetas
  scale_fill_manual(
    values = c("Planificado" = "#2c7bb6", "Real" = "#fdae61"), # Azul vs. Naranja
    labels = c("Planificado", "Real")
  ) +
  
  # Etiquetas y títulos
  labs(
    title = "Avance Mensual: Planificado vs. Real",
    subtitle = paste0("Avance planificado constante (", round(TOTAL_PROGRESO / DURACION_MESES, 2), "% mensual)"),
    x = "Mes de Obra",
    y = "Avance Mensual (%)",
    fill = "Métrica"
  ) +
  
  # Formatear el eje Y como porcentaje
  scale_y_continuous(
      labels = label_percent(scale = 1),
      breaks = pretty_breaks(n = 8)
  ) +
  
  # Tema y ajustes visuales
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7), # Rotar etiquetas X
    legend.position = "top",
    panel.grid.major.x = element_blank() # Eliminar líneas de grilla verticales
  )

# Imprimir el gráfico
print(avance_plot)

```


# COSTOS

### Datos

-   Presupuesto de obra
-   Presupuesto erogado
-   Presupuesto final a termino
-   Avance financiero

| Seguimiento | Valor planificado | Valor Ganado | Costo Actual | SPI  | CPI  |
|-------------|-------------------|--------------|--------------|------|------|
| Cuatrimestre 1 | $2.827.486.693,58 | $2.720.977.795.88 | $2.681.660.372.73 | 0.962 | 1.015 |
| Cuatrimestre 2 | $5.654.973.387,17 | $5.679.862.390,17 | $ 5.522.352.893,35| 1,004 | 1,029 |
| Cuatrimestre 3 | $8.482.460.080,75 | $8.504.914.182,87| $ 8.422.067.978,07 | 1,003 | 1,010 |
| Cuatrimestre 4 | $11.309.946.774,33 | $11.382.601.790,03 | $ 11.422.647.583,14 | 1,006 | 0,996 |
| Cuatrimestre 5 | $14.137.433.467,92| $14.289.682.992,85| $ 14.275.432.715,57 | 1,011 | 1,001 |
| Cuatrimestre 6 | $16.964.920.161,50 | $16.979.132.331,20 | $ 17.222.278.797,84 | 1,001 | 0,986 |

--------------------------------------------------------------

### Grafico

```{r}

## Bloque de código R para tu archivo .Rmd
# Instala y carga las librerías necesarias
# install.packages(c("tidyverse", "scales"))
library(tidyverse)
library(ggplot2)
library(scales) # Necesario para formatear números grandes en el eje Y

# 1. PARÁMETROS DEL PROYECTO
DURACION_MESES <- 48
PRESUPUESTO_TOTAL <- 33929840323

# 2. GENERACIÓN DE DATOS SIMULADOS (Curva S)
# Creamos un vector de períodos
Periodo <- 1:DURACION_MESES

# Generamos el Valor Planificado (PV) usando una curva sigmoide (S-curve)
# que culmina en el presupuesto total.
p_norm <- plogis(Periodo, location = DURACION_MESES / 2, scale = DURACION_MESES / 6)
PV <- (p_norm / max(p_norm)) * PRESUPUESTO_TOTAL

# Generamos el Valor Ganado (EV) y el Costo Real (AC)
# - EV simula un retraso de aproximadamente 3 meses y una ligera ineficiencia (0.98)
# - AC simula un sobrecosto (CPI de 0.90, por lo que el gasto es 1/0.90 ≈ 1.11 veces el valor ganado)
EV <- lag(PV, n = 3, default = 0) * 0.98
AC <- EV * 1.11 

# Aseguramos que EV y AC no sean mayores que el PV en el mes 1
EV[1:3] <- PV[1:3] * 0.9
AC[1:3] <- EV[1:3] * 1.1

# 3. CONSOLIDACIÓN Y TRANSFORMACIÓN
eva_data <- data.frame(Periodo, PV, EV, AC)

# Transformar a formato "largo" para ggplot2
eva_long <- eva_data %>%
  pivot_longer(
    cols = c(PV, EV, AC),
    names_to = "Metrica",
    values_to = "Valor"
  )

# 4. GENERACIÓN DEL GRÁFICO
eva_plot <- ggplot(eva_long, aes(x = Periodo, y = Valor, color = Metrica)) +
  
  # Gráfico de líneas y puntos
  geom_line(linewidth = 1.2) +
  geom_point(size = 1.5) +
  
  # Asignación de colores y etiquetas
  scale_color_manual(
    values = c("PV" = "blue", "EV" = "darkgreen", "AC" = "red"),
    labels = c("AC" = "Costo Real (AC)", "EV" = "Valor Ganado (EV)", "PV" = "Valor Planificado (PV)")
  ) +
  
  # Etiquetas y títulos
  labs(
    title = "Análisis de Valor Ganado (EVA) - Proyecto 48 Meses",
    subtitle = paste0("Presupuesto Total (BAC): $", format(PRESUPUESTO_TOTAL, big.mark = ",", scientific = FALSE)),
    x = "Período (Mes)",
    y = "Valor Acumulado (Miles de Millones $)",
    color = "Métrica del Proyecto"
  ) +
  
  # Formato de eje Y para números grandes
  scale_y_continuous(
    labels = label_number(scale = 1e-9, suffix = ""), # Escala de 10^9
    breaks = pretty_breaks(n = 10)
  ) +
  
  # Formato de eje X para mostrar los 48 meses
  scale_x_continuous(breaks = seq(0, DURACION_MESES, by = 6)) +
  
  # Tema visual
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5)
  )

# Imprimir el gráfico
print(eva_plot)

```

